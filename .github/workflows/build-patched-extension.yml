# .github/workflows/build-patched-extension.yml

name: Build Patched Augment Code Extension with aug_cleaner

on:
  # ÂÖÅËÆ∏ÊâãÂä®Ëß¶ÂèëÂ∑•‰ΩúÊµÅ
  workflow_dispatch:

  # ÊØèÂ§©Êó©‰∏ä 8 ÁÇπ (UTC) Ëá™Âä®ËøêË°åÔºåÊ£ÄÊü•ÊòØÂê¶ÊúâÊñ∞ÁâàÊú¨
  schedule:
    - cron: '0 8 * * *'

  # ÂΩìÂ∑•‰ΩúÊµÅÊñá‰ª∂Ë¢´Êõ¥Êñ∞Êó∂Ëá™Âä®ËøêË°å
  push:
    paths:
      - '.github/workflows/**'

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write # Êéà‰∫àÂ∑•‰ΩúÊµÅÂêë‰ªìÂ∫ìÂàõÂª∫ Release ÁöÑÊùÉÈôê

    steps:
      # Ê≠•È™§ 1: Ê£ÄÂá∫ÂΩìÂâç‰ªìÂ∫ì‰ª£Á†Å
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Ëé∑ÂèñÂÆåÊï¥ÂéÜÂè≤ÔºåÂåÖÊã¨ÊâÄÊúâ tags

      # Ê≠•È™§ 2: Ê£ÄÂá∫ aug_cleaner Â∑•ÂÖ∑‰ª£Á†Å
      - name: Checkout aug_cleaner
        uses: actions/checkout@v4
        with:
          repository: 'gmh5225/aug_cleaner'
          path: 'aug_cleaner'

      # Ê≠•È™§ 3: ËÆæÁΩÆ Python ÁéØÂ¢É (aug_cleaner Ë¶ÅÊ±Ç Python 3.6+)
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      # Ê≠•È™§ 3.1: È™åËØÅ Python ÁâàÊú¨
      - name: Verify Python version
        run: |
          python --version
          python -c "import sys; print(f'Python version: {sys.version}')"
          python -c "import sys; exit(0 if sys.version_info >= (3, 6) else 1)" && echo "‚úÖ Python version meets aug_cleaner requirements (3.6+)"

      # Ê≠•È™§ 4: ‰∏ãËΩΩÊúÄÊñ∞ÁöÑ Augment Code VSIX Êèí‰ª∂
      - name: Download Latest VSIX
        run: |
          PUBLISHER="augmentcode"
          EXTENSION_NAME="augment"
          VSIX_URL="https://marketplace.visualstudio.com/_apis/public/gallery/publishers/${PUBLISHER}/vsextensions/${EXTENSION_NAME}/latest/vspackage"
          echo "Downloading VSIX from: ${VSIX_URL}"

          # ‰ΩøÁî®Êõ¥Âº∫ÁöÑ‰∏ãËΩΩÂèÇÊï∞ÔºåÂ§ÑÁêÜÈáçÂÆöÂêëÂíåÂéãÁº©
          curl -L \
            --fail \
            --retry 3 \
            --retry-delay 5 \
            --max-time 300 \
            --user-agent "Mozilla/5.0 (compatible; GitHub-Actions)" \
            --header "Accept: application/octet-stream, */*" \
            --output original.vsix \
            "${VSIX_URL}"

          echo "VSIX downloaded successfully."

          # ËØ¶ÁªÜÈ™åËØÅÊñá‰ª∂
          echo "File information:"
          ls -la original.vsix
          echo "File type:"
          file original.vsix
          echo "File size: $(stat -c%s original.vsix) bytes"

          # Ê£ÄÊü•Êñá‰ª∂Â§¥ÈÉ®ÔºåÁ°ÆËÆ§ÊòØÂê¶‰∏∫ ZIP Ê†ºÂºè
          echo "File header (hex):"
          hexdump -C original.vsix | head -3

          # È™åËØÅÊòØÂê¶‰∏∫ÊúâÊïàÁöÑ ZIP Êñá‰ª∂
          if ! file original.vsix | grep -q "Zip\|ZIP"; then
            echo "Error: Downloaded file is not a valid ZIP/VSIX file"
            echo "File content preview:"
            head -20 original.vsix
            exit 1
          fi

      # Ê≠•È™§ 5: Ëß£ÂåÖ VSIX Êñá‰ª∂
      - name: Unpack VSIX
        run: |
          echo "Unpacking VSIX file..."

          # ÊµãËØï ZIP Êñá‰ª∂ÂÆåÊï¥ÊÄß
          if ! unzip -t original.vsix > /dev/null 2>&1; then
            echo "Error: VSIX file is corrupted or not a valid ZIP file"
            echo "Attempting to diagnose the issue..."
            echo "File size: $(stat -c%s original.vsix) bytes"
            echo "File type: $(file original.vsix)"
            echo "First 200 bytes of file:"
            head -c 200 original.vsix | hexdump -C
            exit 1
          fi

          # Ëß£ÂåÖÊñá‰ª∂
          unzip -q original.vsix -d unpacked_ext
          echo "VSIX unpacked successfully."

          # Êü•ÁúãËß£ÂåÖÂêéÁöÑÁªìÊûÑ
          echo "Unpacked structure:"
          find unpacked_ext -type f -name "*.json" | head -5
          find unpacked_ext -type f -name "*.js" | head -10

          # Êü•ÁúãÁõÆÂΩïÁªìÊûÑ
          echo "Directory structure:"
          find unpacked_ext -type d | head -10

      # Ê≠•È™§ 6: ‰ªéÊèí‰ª∂ÁöÑ package.json ‰∏≠Ëé∑ÂèñÁâàÊú¨Âè∑
      - name: Get extension version
        id: get_version
        run: |
          # Êü•Êâæ package.json Êñá‰ª∂
          PACKAGE_JSON=$(find unpacked_ext -name "package.json" -type f | head -1)
          if [ -z "$PACKAGE_JSON" ]; then
            echo "Error: package.json not found"
            exit 1
          fi
          echo "Found package.json at: $PACKAGE_JSON"
          
          VERSION=$(jq -r .version "$PACKAGE_JSON")
          if [ "$VERSION" = "null" ] || [ -z "$VERSION" ]; then
            echo "Error: Could not extract version from package.json"
            exit 1
          fi
          
          echo "VERSION=${VERSION}" >> $GITHUB_ENV
          echo "Discovered extension version: ${VERSION}"

      # Ê≠•È™§ 7: Ê£ÄÊü•ÁâàÊú¨ÊòØÂê¶Â∑≤Â≠òÂú®
      - name: Check if version already exists
        id: version_check
        run: |
          TAG_NAME="v${{ env.VERSION }}-patched"
          if git tag -l | grep -q "^${TAG_NAME}$"; then
            echo "Tag ${TAG_NAME} already exists, skipping build"
            echo "skip_build=true" >> $GITHUB_OUTPUT
          else
            echo "New version ${{ env.VERSION }} detected, proceeding with build"
            echo "skip_build=false" >> $GITHUB_OUTPUT
          fi

      # Ê≠•È™§ 8: ÊòæÁ§∫Ë∑≥ËøáÊûÑÂª∫ÁöÑ‰ø°ÊÅØÔºà‰ªÖÂú®Ë∑≥ËøáÊó∂ÊâßË°åÔºâ
      - name: Skip build notification
        if: steps.version_check.outputs.skip_build == 'true'
        run: |
          echo "‚úÖ Version ${{ env.VERSION }} already exists, skipping build"
          echo "üîÑ To rebuild: delete tag v${{ env.VERSION }}-patched and its release"

      # Ê≠•È™§ 9: ‰ΩøÁî® aug_cleaner Â∑•ÂÖ∑ËøõË°åË°•‰∏ÅÔºà‰ªÖÂú®ÈúÄË¶ÅÊûÑÂª∫Êó∂ÊâßË°åÔºâ
      - name: Apply patch with aug_cleaner
        if: steps.version_check.outputs.skip_build == 'false'
        run: |
          echo "Applying patch with aug_cleaner..."
          
          # Êü•Êâæ‰∏ªË¶ÅÁöÑ extension.js Êñá‰ª∂
          EXTENSION_JS=$(find unpacked_ext -name "extension.js" -path "*/out/*" | head -1)
          if [ -z "$EXTENSION_JS" ]; then
            echo "Error: extension.js not found in unpacked VSIX"
            exit 1
          fi
          echo "Found extension.js at: $EXTENSION_JS"
          
          # ‰ΩøÁî® aug_cleaner Â∑•ÂÖ∑ËøõË°åË°•‰∏Å
          python aug_cleaner/aug_cleaner.py "$EXTENSION_JS" "${EXTENSION_JS}.patched"
          
          # ÊõøÊç¢ÂéüÊñá‰ª∂
          mv "${EXTENSION_JS}.patched" "$EXTENSION_JS"
          
          echo "Patch applied successfully with aug_cleaner."

      # Ê≠•È™§ 10: ËÆæÁΩÆ Node.js ÁéØÂ¢ÉÔºà‰ªÖÂú®ÈúÄË¶ÅÊûÑÂª∫Êó∂ÊâßË°åÔºâ
      - name: Setup Node.js
        if: steps.version_check.outputs.skip_build == 'false'
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # Ê≠•È™§ 11: ÂÆâË£ÖÂøÖË¶ÅÁöÑÂ∑•ÂÖ∑Ôºà‰ªÖÂú®ÈúÄË¶ÅÊûÑÂª∫Êó∂ÊâßË°åÔºâ
      - name: Install dependencies
        if: steps.version_check.outputs.skip_build == 'false'
        run: |
          npm install -g @vscode/vsce

      # Ê≠•È™§ 12: Êü•ÊâæÂπ∂ÂáÜÂ§áÊèí‰ª∂ÁõÆÂΩï
      - name: Prepare extension directory
        if: steps.version_check.outputs.skip_build == 'false'
        run: |
          # Êü•ÊâæÂåÖÂê´ package.json ÁöÑÁõÆÂΩï
          EXTENSION_DIR=$(find unpacked_ext -name "package.json" -type f -exec dirname {} \; | head -1)
          if [ -z "$EXTENSION_DIR" ]; then
            echo "Error: Extension directory not found"
            exit 1
          fi
          echo "EXTENSION_DIR=${EXTENSION_DIR}" >> $GITHUB_ENV
          echo "Extension directory: $EXTENSION_DIR"

      # Ê≠•È™§ 13: ÂÆâË£ÖÊèí‰ª∂‰æùËµñÂπ∂ÂàõÂª∫ .vscodeignore
      - name: Install extension dependencies
        if: steps.version_check.outputs.skip_build == 'false'
        working-directory: ${{ env.EXTENSION_DIR }}
        run: |
          # Â¶ÇÊûúÂ≠òÂú® package-lock.json Êàñ node_modulesÔºåÂÖàÊ∏ÖÁêÜ
          rm -rf node_modules package-lock.json
          
          # ÂÆâË£Ö‰æùËµñÔºàÂ¶ÇÊûú package.json ‰∏≠Êúâ‰æùËµñÔºâ
          if [ -f package.json ] && jq -e '.dependencies // .devDependencies' package.json > /dev/null 2>&1; then
            npm install --production
          fi
          
          # ÂàõÂª∫ .vscodeignore Êñá‰ª∂
          cat > .vscodeignore << EOF
          node_modules/
          .git/
          .gitignore
          *.md
          .vscode/
          test/
          src/
          tsconfig.json
          webpack.config.js
          EOF
          echo "Dependencies installed and .vscodeignore created."

      # Ê≠•È™§ 14: ÈáçÊñ∞ÊâìÂåÖÊàêÊñ∞ÁöÑ VSIX Êñá‰ª∂
      - name: Repackage Patched VSIX
        if: steps.version_check.outputs.skip_build == 'false'
        run: |
          PATCHED_VSIX_NAME="augmentcode.augment-${{ env.VERSION }}-patched.vsix"
          echo "PATCHED_VSIX_NAME=${PATCHED_VSIX_NAME}" >> $GITHUB_ENV
          
          cd "${{ env.EXTENSION_DIR }}"
          vsce package --out "../../${PATCHED_VSIX_NAME}"
          
          echo "Patched VSIX created: ${PATCHED_VSIX_NAME}"
          ls -l "../../${PATCHED_VSIX_NAME}"

      # Ê≠•È™§ 15: ÂàõÂª∫ GitHub Release Âπ∂‰∏ä‰º†ÊâìÂåÖÂ•ΩÁöÑ VSIX
      - name: Create GitHub Release
        if: steps.version_check.outputs.skip_build == 'false'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "v${{ env.VERSION }}-patched"
          name: "Patched Augment v${{ env.VERSION }}"
          body: |
            This is an automated build of the Augment extension, patched with the aug_cleaner tool.
            
            - Original Extension Version: **${{ env.VERSION }}**
            - Patch Tool: aug_cleaner (https://github.com/gmh5225/aug_cleaner)
            - Build Date: ${{ github.run_id }}
            
            ## Installation
            1. Download the `.vsix` file below
            2. Open VS Code
            3. Go to Extensions view (Ctrl+Shift+X)
            4. Click the "..." menu and select "Install from VSIX..."
            5. Select the downloaded file
            
            ## What's Patched
            This version has been processed by aug_cleaner to remove telemetry and tracking functionality.
          files: "${{ env.PATCHED_VSIX_NAME }}"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Ê≠•È™§ 16: Ê∏ÖÁêÜ‰∏¥Êó∂Êñá‰ª∂
      - name: Cleanup
        if: always()
        run: |
          rm -rf unpacked_ext original.vsix aug_cleaner
          echo "Cleanup completed."
